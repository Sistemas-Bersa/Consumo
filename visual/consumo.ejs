<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Salida de Inventario | Bersa</title>
    <link rel="stylesheet" href="/estilos.css">
    <script src="https://unpkg.com/lucide@latest"></script>
</head>
<body>
    <div class="container">
        <!-- HEADER -->
        <header class="header-top">
            <div class="brand">
                <div class="brand-icon"><i data-lucide="minus-circle" style="color: var(--azul-bersa)"></i></div>
                <h1 style="margin:0">Módulo <span class="text-naranja">Consumo</span></h1>
            </div>
            <a href="https://bersacloud.app" class="btn-inicio">
                <i data-lucide="home" size="18"></i> INICIO
            </a>
        </header>

        <!-- TOOLBAR ÚNICA -->
        <div class="toolbar-grid">
            <div>
                <label class="label-herramienta">ALMACÉN</label>
                <select class="search-input" onchange="location.href='/consumo?wh='+this.value">
                    <% almacenesPermitidos.forEach(wh => { %>
                        <option value="<%= wh.clave_sap %>" <%= almacenActivo === wh.clave_sap ? 'selected' : '' %>><%= wh.nombre %></option>
                    <% }) %>
                </select>
            </div>
            <div>
                <label class="label-herramienta">BUSCAR PRODUCTO</label>
                <input type="text" id="buscador" class="search-input" placeholder="Filtrar por nombre..." onkeyup="filtrarTabla()">
            </div>
            <button onclick="registrarSalidas()" class="btn-guardar-top">
                <i data-lucide="send" size="18"></i> REGISTRAR SALIDAS
            </button>
        </div>

        <!-- TABLA -->
        <div class="table-wrapper">
            <table class="stock-table" id="tablaStock">
                <thead>
                    <tr>
                        <th style="width: 40%;">Producto / Descripción</th>
                        <th style="text-align: center;">Unidad</th>
                        <th style="text-align: center;">Stock Actual</th>
                        <th style="text-align: center;">Retirar</th>
                        <th style="text-align: center;">Saldo Final</th>
                    </tr>
                </thead>
                <tbody>
                    <% if (datos.length > 0) { %>
                        <% datos.forEach((p, index) => { %>
                            <% 
                                // Detectamos si es pieza para bloquear decimales
                                const esPieza = (p.unidad || '').toUpperCase().includes('PIEZA') || (p.unidad || '').toUpperCase().includes('PZ');
                            %>
                            <tr class="stock-row">
                                <td style="font-weight: 700;"><%= p.producto %></td>
                                <td class="text-unidad" style="text-align: center;"><%= p.unidad || 'PIEZA' %></td>
                                <td class="text-stock" style="text-align: center;">
                                    <span id="stock-<%= index %>"><%= parseFloat(p.stock_actual).toFixed(3) %></span>
                                </td>
                                <td style="text-align: center;">
                                    <input type="number" 
                                           step="<%= esPieza ? '1' : 'any' %>" 
                                           class="input-fisico" 
                                           placeholder="<%= esPieza ? '0' : '0.000' %>"
                                           data-codigo="<%= p.codigo_general %>"
                                           data-index="<%= index %>"
                                           data-es-pieza="<%= esPieza %>"
                                           onkeypress="return validarTecla(event, this)"
                                           oninput="calcularSaldo(this)">
                                </td>
                                <td class="text-saldo" style="text-align: center;">
                                    <span id="saldo-<%= index %>"><%= parseFloat(p.stock_actual).toFixed(3) %></span>
                                </td>
                            </tr>
                        <% }) %>
                    <% } else { %>
                        <tr><td colspan="5" class="no-data">No hay inventario físico reportado en este almacén.</td></tr>
                    <% } %>
                </tbody>
            </table>
        </div>
    </div>

    <script>
        lucide.createIcons();

        // Bloqueo de decimales para piezas
        function validarTecla(event, input) {
            const esPieza = input.getAttribute('data-es-pieza') === 'true';
            if (!esPieza) return true;
            const charCode = (event.which) ? event.which : event.keyCode;
            if (charCode > 31 && (charCode < 48 || charCode > 57)) return false;
            return true;
        }

        function calcularSaldo(input) {
            const idx = input.getAttribute('data-index');
            const esPieza = input.getAttribute('data-es-pieza') === 'true';
            
            if(esPieza) input.value = input.value.replace(/[^0-9]/g, '');

            const actual = parseFloat(document.getElementById(`stock-${idx}`).innerText) || 0;
            const retiro = parseFloat(input.value) || 0;
            
            const total = actual - retiro;
            const display = document.getElementById(`saldo-${idx}`);
            display.innerText = total.toFixed(3);

            if (total < 0) {
                display.classList.add('text-alerta');
            } else {
                display.classList.remove('text-alerta');
            }
        }

        async function registrarSalidas() {
            const inputs = Array.from(document.querySelectorAll('.input-fisico')).filter(i => parseFloat(i.value) > 0);
            if(inputs.length === 0) return alert("⚠️ Ingrese cantidades a retirar.");

            const conteos = inputs.map(i => ({
                codigo: i.getAttribute('data-codigo'),
                cantidad: parseFloat(i.value) * -1 // SE ENVÍA NEGATIVO A SQL
            }));

            if(!confirm(`¿Confirmar retiro de ${conteos.length} artículos?`)) return;

            const res = await fetch('/procesar-ajuste', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ almacen: '<%= almacenActivo %>', conteos })
            });

            if (res.ok) { 
                alert("✅ Consumo registrado correctamente."); 
                location.reload(); 
            } else { 
                const err = await res.json();
                alert("❌ Error: " + (err.error || "No se pudo guardar.")); 
            }
        }

        function filtrarTabla() {
            const val = document.getElementById("buscador").value.toUpperCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "");
            const rows = document.getElementsByClassName("stock-row");
            for (let r of rows) {
                const text = r.innerText.toUpperCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "");
                r.style.display = text.includes(val) ? "" : "none";
            }
        }
    </script>
</body>
</html>